---
title: "æœ€ä¼˜åˆ†ç±»é˜ˆå€¼"
date: 2024-05-11
description: "åˆ†ç±»é—®é¢˜ä¸­é˜ˆå€¼çš„é€‰æ‹©"
image: "https://cdn.jsdelivr.net/gh/Leslie-Lu/WeChatOfficialAccount/img/202405112020810.png"
categories:
  - python
  - machine learning
format:
  html: 
    shift-heading-level-by: 1
    include-in-header:
      - text: |
          <style type="text/css">
          hr.dinkus {
              width: 50px;
              margin: 2em auto 2em;
              border-top: 5px dotted #454545;
          }
          
          div.column-margin+hr.dinkus {
              margin: 1em auto 2em;
          }
          </style>
# doi: 
citation: true
jupyter: python3
---

è¿™é‡Œæˆ‘ä»¬å€ŸåŠ©*scikit-learn*æ¥æ¢è®¨åˆ†ç±»é—®é¢˜ä¸­é˜ˆå€¼çš„é€‰æ‹©ã€‚

## æ•°æ®å‡†å¤‡å’Œå‚æ•°é€‰æ‹©

é¦–å…ˆæ˜¯æ•°æ®å‡†å¤‡ï¼š

```{python}
#| label: libraries-n-things
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

from sklearn.datasets import load_breast_cancer
from sklearn.model_selection import train_test_split
from sklearn.metrics import confusion_matrix

np.set_printoptions(suppress=True, precision=8, linewidth=1000)
pd.options.mode.chained_assignment = None
pd.set_option('display.max_columns', None)
pd.set_option('display.width', None)

data = load_breast_cancer()
X = data["data"]
y = data["target"]

Xtrain, Xvalid, ytrain, yvalid = train_test_split(X, y, test_size=.20, random_state=516)

print(f"Xtrain.shape: {Xtrain.shape}")
print(f"Xvalid.shape: {Xvalid.shape}")
```

æ¨¡å‹æˆ‘ä»¬è¿™é‡Œé€‰æ‹©*éšæœºæ£®æ—*ã€‚è¶…å‚çš„é€‰æ‹©ï¼ŒåŸºäº`GridSearchCV`ï¼Œè¿™é‡Œä¹Ÿä¸èµ˜è¿°ã€‚æœ‰ä¸€ä¸ªç‚¹éœ€è¦è¯´æ˜ï¼Œç”±äºä½¿ç”¨çš„æ˜¯è‚¿ç˜¤æ•°æ®é›†ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯`recall`ï¼Œå³å°½é‡å‡å°‘å‡é˜´æ€§çš„æƒ…å†µã€‚å› è€Œï¼Œæˆ‘ä»¬åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œä¹Ÿæ˜¯å°†recallä½œä¸ºè¯„ä»·æŒ‡æ ‡ã€‚

```{python}
#| label: train-model-rf
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import GridSearchCV

param_grid = {
    "n_estimators": [100, 150, 250],
    "min_samples_leaf": [2, 3, 4],
    "ccp_alpha": [0, .1, .2, .3]
    }

mdl = GridSearchCV(
    RandomForestClassifier(random_state=516), 
    param_grid, 
    scoring="recall", 
    cv=5
    )

mdl.fit(Xtrain, ytrain)

print(f"best parameters: {mdl.best_params_}")
```

## æ¨¡å‹é¢„æµ‹

æ‹¿åˆ°æ¨¡å‹åï¼Œè‡ªç„¶æˆ‘ä»¬å¯ä»¥å¼€å§‹é¢„æµ‹ï¼š

```{python}
#| label: predict
ypred = mdl.predict_proba(Xvalid)[:,1]
ypred
```

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¦è®²çš„ä¸œè¥¿å°±æ¥äº†ã€‚ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©0.50ä½œä¸ºåˆ†ç±»é˜ˆå€¼ï¼Œå³å¤§äº0.50çš„ä¸ºæ­£ç±»ï¼Œå°äº0.50çš„ä¸ºè´Ÿç±»ã€‚

```{python}
#| label: threshold-0.50
ypred = mdl.predict_proba(Xvalid)[:,1].reshape(-1, 1)
yhat = mdl.predict(Xvalid).reshape(-1, 1)
preds = np.concatenate([ypred, yhat], axis=1)
print(preds)
print(confusion_matrix(yvalid, yhat))
```

ä½†æ˜¯ï¼Œè¿™ä¸ªé˜ˆå€¼æ˜¯å¯ä»¥è°ƒæ•´çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´é˜ˆå€¼æ¥è¾¾åˆ°ä¸åŒçš„ç›®çš„ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´é˜ˆå€¼æ¥å‡å°‘å‡é˜´æ€§çš„æƒ…å†µï¼Œè¿™åœ¨ç±»åˆ«ä¸å¹³è¡¡æ—¶å°¤ä¸ºé‡è¦ã€‚

## é˜ˆå€¼çš„é€‰æ‹©

æˆ‘ä»¬ä»‹ç»å‡ ç§å¸¸ç”¨çš„æ–¹æ³•ã€‚

### 1. é˜³æ€§ç±»åˆ«prevalance

æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªæ•°æ®é›†ä¸­é˜³æ€§ç±»åˆ«çš„æ¯”ä¾‹ï¼š

```{python}
#| label: positive-prevalance
print(f"Proportion of positives in training set: {ytrain.sum() / ytrain.shape[0]:.2f}")
```

è¿™ä¸ªtoyæ•°æ®é›†å¾ˆå¤¸å¼ å“ˆï¼Œè¾¾åˆ°äº†0.62ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸ªæ¯”ä¾‹å¯èƒ½åªæœ‰10%æˆ–è€…1%ã€‚è¿™é‡Œæˆ‘ä»¬åªæ˜¯æ‹¿å®ƒç¤ºä¾‹å“ˆï¼Œç”¨è¿™ä¸ªprevalanceæ¥ä½œä¸ºé˜ˆå€¼ã€‚

```{python}
#| label: threshold-prevalance
thresh = 1- ytrain.sum() / ytrain.shape[0]
yhat = np.where(ypred <= thresh, 0, 1)
print(confusion_matrix(yvalid, yhat))
```

è€ƒè™‘prevalanceçš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ç±»åˆ«ä¸å¹³è¡¡çš„æƒ…å†µä¸‹ï¼Œå‡å°‘å‡é˜´æ€§çš„æƒ…å†µã€‚

### 2. æœ€ä¼˜F1æŒ‡æ•°

F1æŒ‡æ•°æ˜¯precisionå’Œrecallçš„è°ƒå’Œå¹³å‡æ•°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æœ€å¤§F1æŒ‡æ•°æ¥é€‰æ‹©æœ€ä¼˜çš„é˜ˆå€¼ã€‚

```{python}
#| label: threshold-f1
#| echo: false
from sklearn.metrics import precision_recall_curve
p, r, thresh = precision_recall_curve(yvalid, ypred)
f1 = 2 * (p * r) / (p + r)

best_thresh = thresh[np.argmax(f1)]
print(f"Threshold using optimal f1-score: {best_thresh:,.3f}.")
```

F1æœ€é«˜ä¸º0.471ï¼Œæˆ‘ä»¬é‡‡ç”¨å®ƒæ¥è¿›è¡Œé¢„æµ‹ï¼š

```{python}
#| label: threshold-f1-predict
thresh = .471
yhat = np.where(ypred <= thresh, 0, 1)
print(confusion_matrix(yvalid, yhat))
```

### 3. ROCæ›²çº¿

æˆ‘ä»¬å¯ä»¥é€šè¿‡[ROCæ›²çº¿](https://mp.weixin.qq.com/s/Zw85hAdx7VdwCioG5NwHQw)æ¥é€‰æ‹©æœ€ä¼˜çš„é˜ˆå€¼ã€‚ROCæ›²çº¿ä¸‹çš„é¢ç§¯AUCè¶Šå¤§ï¼Œè¯´æ˜æ¨¡å‹è¶Šå¥½ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©ROCæ›²çº¿æœ€é è¿‘å·¦ä¸Šè§’çš„ç‚¹ä½œä¸ºæœ€ä¼˜é˜ˆå€¼ã€‚

```{python}
#| label: threshold-roc
#| fig-align: center
#| echo: false
from sklearn.metrics import RocCurveDisplay
roc_disp = RocCurveDisplay.from_predictions(
    yvalid, ypred, name="RandomForestClassifier", color="#191964"
    )
roc_disp.ax_.set_title("ROC curve", fontsize=9)
roc_disp.ax_.grid(True)
plt.show()
```

### 4. PRCæ›²çº¿

PRCæ›²çº¿æ˜¯[precision-recallæ›²çº¿](https://mp.weixin.qq.com/s/Zw85hAdx7VdwCioG5NwHQw)ã€‚ç›¸æ¯”äºROCæ›²çº¿ï¼ŒPRCæ›²çº¿æ›´é€‚åˆç±»åˆ«ä¸å¹³è¡¡çš„æƒ…å†µã€‚æˆ‘ä»¬ä¸»è¦é€‰æ‹©PRCæ›²çº¿æœ€é è¿‘å³ä¸Šè§’çš„ç‚¹ä½œä¸ºæœ€ä¼˜é˜ˆå€¼ã€‚

```{python}
#| label: threshold-prc
#| fig-align: center
#| echo: false
from sklearn.metrics import PrecisionRecallDisplay
pr_disp = PrecisionRecallDisplay.from_predictions(
    yvalid, ypred, name="RandomForestClassifier", color="#CD0066"
    )
pr_disp.ax_.set_title("Precision-Recall curve", fontsize=9)
pr_disp.ax_.grid(True)
plt.show()

p, r, thresh = precision_recall_curve(yvalid, ypred)
best_thresh = thresh[np.where(r >= .95)[-1][-1]]
print(f"Selected threshold using precision-recall curve: {best_thresh:,.3f}.")
```

### 5. åˆ†åˆ«å…³æ³¨precisionå’Œrecall

æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´é˜ˆå€¼æ¥åˆ†åˆ«å…³æ³¨precisionå’Œrecallã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´é˜ˆå€¼æ¥æé«˜recallï¼Œå‡å°‘å‡é˜´æ€§çš„æƒ…å†µã€‚

```{python}
#| label: threshold-pre-recall
#| fig-align: center
#| echo: false
p, r, thresh = precision_recall_curve(yvalid, ypred)
p, r = p[:-1], r[:-1]

fig, ax =  plt.subplots(1, 1, figsize=(6.5, 4), tight_layout=True)
ax.set_title("precision & recall vs. threshold", fontsize=10)
ax.plot(thresh, p, color="red", linewidth=1.25, label="precision")
ax.plot(thresh, r, color="blue", linewidth=1.25, label="recall")
ax.set_xlabel("threshold", fontsize=8)
# ax.set_xticks(np.arange(tmax+1))
ax.tick_params(axis="x", which="major", direction="in", labelsize=8)
ax.tick_params(axis="y", which="major", direction="in", labelsize=8)
ax.xaxis.set_ticks_position("none")
ax.yaxis.set_ticks_position("none")
ax.grid(True)
ax.legend(loc="upper right", fancybox=True, framealpha=1, fontsize="medium")

plt.show()
```

<br>

ä»£ç å·²ç»æ”¾è¿›äº†[æ˜Ÿçƒ](https://mp.weixin.qq.com/s/4IR-KMAZ-q2VbI0Fz4fYRg)é‡Œã€‚

<br>

#### Did you find this page helpful? Consider sharing it ğŸ™Œ
